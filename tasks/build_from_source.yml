---

- name: establish build prerequisites
  package:
    name: "{{ compiler_needed_tools + ['wget','tar'] }}"
    state: present

- name: prepare paths
  set_fact:
    source_path: "{{ dir + '/gcc-' + version }}"
    build_dir_path: "{{ dir + '/gcc-' + version + '/build/' }}"

- name: extract source tarball
  become: yes
  unarchive:
    src: "https://ftp.gnu.org/gnu/gcc/gcc-{{ version }}/gcc-{{ version }}.tar.gz"
    remote_src: yes
    dest: "{{ dir }}"

- name: download prerequisites
  shell: "./contrib/download_prerequisites"
  args:
    chdir: "{{ source_path }}"
    creates: "{{ source_path }}/gmp-4.3.2.tar.bz2"

- name: ensure build directory existence
  become: yes
  file:
    path: "{{ build_dir_path }}" 
    state: directory

- name: configure build process
  shell: "{{ source_path }}/configure {{ compiler_args | join(' ') }}" 
  args:
    chdir: "{{ build_dir_path }}"

- name: build 
  make:
    chdir: "{{ build_dir_path }}"
    target: all
    params:
      --jobs: "{{ ansible_processor_cores * ansible_processor_threads_per_core }}" 
 
- name: install 
  make:
    chdir: "{{ build_dir_path }}"
    target: install
  when:
    - install | bool

